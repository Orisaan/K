<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>דו"ח זכויות – תל אביב</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    .header { background:#1a73e8; color:#fff; padding:10px; }
    .toolbar { margin:10px; display:flex; gap:8px; }
    .map { height:400px; margin:10px; }
    table { width:100%; border-collapse:collapse; margin:10px; }
    th,td { border:1px solid #ddd; padding:6px; text-align:right; }
    th { background:#f0f4ff; color:#1a73e8; }
  </style>
</head>
<body>
  <div class="header">
    <h2>דו"ח זכויות – תל אביב (ArcGIS)</h2>
  </div>
  <div class="toolbar">
    <input id="address" placeholder="6215/56" style="flex:1"/>
    <button id="btnFetch">משוך נתונים</button>
  </div>
  <div id="map" class="map"></div>
  <table>
    <thead>
      <tr>
        <th>שכבה</th>
        <th>נתונים</th>
      </tr>
    </thead>
    <tbody id="results"><tr><td colspan="2">—</td></tr></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const PROXY = location.origin; // Render proxy
    const LAYER_IDS = [954,766,764,423,762,761,760,763,633,950,525,524,682,514];
    const LAYER_URL = id => `https://gisn.tel-aviv.gov.il/arcgis/rest/services/IView2/MapServer/${id}`;

    const map = L.map('map').setView([32.08,34.78],15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const drawn = new L.FeatureGroup().addTo(map);

    async function fetchGeom(gush,helka){
      const url = `${PROXY}/api/govmap/lotParcelGeometry?gush=${gush}&helka=${helka}`;
      const r = await fetch(url); return await r.json();
    }

    async function queryLayer(layerId, geometry){
      const r = await fetch(`${PROXY}/api/arcgis/query`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({layerUrl:LAYER_URL(layerId), geometry, outFields:'*'})
      });
      return await r.json();
    }

    async function fetchAll(){
      try{
        const v = document.getElementById('address').value.trim();
        if(!/^\d+\/\d+$/.test(v)){ alert("הכנס גוש/חלקה"); return; }
        const [gush,helka] = v.split('/');

        // קבל גיאומטריה
        const gm = await fetchGeom(gush,helka);
        const gj = gm.geojson || gm.GEOJSON;
        drawn.clearLayers();
        if(gj){ const lyr=L.geoJSON(gj,{color:'red'}).addTo(drawn); map.fitBounds(lyr.getBounds()); }

        // טבלת תוצאות
        const tb=document.getElementById('results'); tb.innerHTML="";
        for(const id of LAYER_IDS){
          const data = await queryLayer(id, gj);
          const feats = data.features||[];
          tb.innerHTML += `<tr>
            <td>${id}</td>
            <td>${feats.length? JSON.stringify(feats[0].attributes).substring(0,120)+"..." : "אין נתונים"}</td>
          </tr>`;
        }
      }catch(e){console.error(e); alert("שגיאה בשליפה");}
    }

    document.getElementById('btnFetch').onclick = fetchAll;
  </script>
</body>
</html>
